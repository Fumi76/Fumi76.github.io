<html>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="css/style.css" />
</head>
<body>
<div style="width: 100%;" align="center">
    <div style="margin-top: 20px; width: 80%; text-align: left;">

        <h1><a href="/">Auroraメモ</a></h1>

        <h2>Aurora MySQLのレプリケーション</h2>

        <h3>レプリケーションの選択肢</h3>
        <ul>
            <li>Aurora レプリカ (<a href="dbcluster.html">DBクラスター参照</a>)</li>
            <li>別のリージョンにもう1つDBクラスター(とそのレプリカ)を作成する。別々のリージョンに2つのDBクラスター構成</li>
            <li>同一リージョンに2つのDBクラスターを配置し、MySQLのバイナリログによりレプリケーションを使用する</li>
            <li>マスターとしてRDSのDBインスタンス、とAuroraのDBクラスターにそのレプリカを作成する。これは通常はAuroraへの移行方法として利用される</li>
        </ul>

        <h3>パフォーマンスに関する考慮事項</h3>
        <ul>
        <li>レプリカログの圧縮機能によりレプリケーションメッセージが占めるネットワーク帯域を減らすことができる。メッセージはすべてのレプリカに送信されるため、クラスターの規模が大きいほど効果がある</li>
        <li>圧縮を行う書き込み役のノード上である程度のCPUのオーバーヘッドがあるので、この機能は8xlargeと16xlargeのインスタンスタイプでのみ使用可能。これらのインスタンスクラスではこの機能はデフォルトで有効になっている</li>
        <li>aurora_enable_replica_log_compression パラメータで無効にすることもできる。書き込み役のノードのCPU負荷が高い場合など</li>
        <li>バイナリログのフィルタリング機能はレプリケーションメッセージが占めるネットワーク帯域を減らすことができる。レプリカはレプリケーションメッセージに含まれるバイナリログの情報を使用しないので、レプリカに送信されるメッセージからはその情報は省かれる</li>
        <li>aurora_enable_repl_bin_log_filtering パラメータでこの機能のオンオフを制御できる。デフォルトはオン。この最適化は透過的なので、レプリケーションに関係する問題の調査やトラブルシューティングのときにだけオフにされることを想定</li>
        </ul>

        <h3>高可用性に関する考慮事項</h3>
        <ul>
            <li>レプリカの数を増やすと可用性が向上する</li>
            <li>複数のレプリカを持つ場合の難点は、基盤となるDBインスタンスが再起動されるときにレプリカも短時間使用できなくなる。再起動はメンテナンス作業中、あるいはあるレプリカのラグが大きくなりすぎたときにありうる</li>
            <li>レプリカを再起動すると当該のDBインスタンスへの既存の接続は切断される</li>
            <li>クラスターを再起動するとすべてのレプリカが同時に使用できなくなる</li>
            <li>ゼロダウンタイム再起動機能は、レプリカ再起動時の可用性を可能にする。例えばラグが大きくなりすぎたレプリカが再起動する時に、既存の接続を維持する。進行中のトランザクションはロールバックされるのでアプリ側でリトライする必要がある</li>
            <li>この機能を有効にするにはクラスターパラメーターグループでaurora_enable_zdr をオンにする。デフォルトはオフ</li>
        </ul>

        <h3>レプリケーションのモニタリング</h3>
        <ul>
            <li>読み取りのスケーリングと高可用性はレプリカラグが小さいことを前提としている</li>
            <li>CloudWatchのReplicaLagで確認</li>
            <li>このReplicaLagはプライマリインスタンスのページキャッシュと比べたレプリカのページキャッシュのラグを意味している。クラスターボリュームは同じものを見ているため</li>
            <li>レプリカラグの最も最新の値はmysql.ro_replica_statusテーブルのReplica_lag_in_msec を見る。この値がCloudWatchのReplicaLag に表示されている。INFORMATION_SCHEMA.REPLICA_HOST_STATUSにも表示されている</li>
            <li>モニタリングについては<a href="https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/MonitoringAurora.html">このページ</a>も参照</li>
        </ul>
    </div>
</div>
</body>
</html>