<html>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="css/style.css" />
</head>
<body>
<div style="width: 100%;" align="center">

<div style="margin-top: 20px; width: 80%; text-align: left;">
<p>更新日： 2019/7/28</p>
<hr>
    <h1><a href="/">Aurora MySQLメモ</a></h1>

	<h2>フェイルオーバー</h2>
	
	<ul>
		<li>
			Auroraクラスター側
			<ul>
				<li>
					マスターのダウン
					<ul>
						<li>レプリカがあれば、そのうちの1台にフェイルオーバーする（マスターに昇格する）。フェイルオーバーは通常30秒以内に完了する。</li>
						<li>フェイルオーバーによってクラスターエンドポイントが指すIPアドレスが変更される。（DNSレコードの更新）</li>
						<li>フェイルオーバーによってマスターが変わった際にすべてのレプリカも再起動される。つまりレプリカへの接続は一旦切断される。</li>
						<li>レプリカにマスターに昇格させる優先順位を指定することができる</li>
						<li>レプリカがいない場合は、マスターと同じAZに新しくDBインスタンスを作成する。</li>
						<li>クライアントに正常完了が返った書き込みついてはマスターのクラッシュでも消えていることはない。クラッシュのタイミングによっては正常完了が返らなかった書き込みが実際は完了しているということはありえそうである</li>
					</ul>
				</li>
				<li>
					レプリカのダウン
					<ul>
						<li>そのレプリカに接続していたクライアントは切断されるので影響あり</li>
						<li>読み取りエンドポイントからは自動的に振り分け対象から削除される</li>
						<li>マスターに対する影響は特になさそうである</li>
						<li>一定数のレプリカを保ちたいのであれば Auto Scaling Group を構成する（要確認)</li>
					</ul>
				</li>
			</ul>
		</li>
		<li>
			クライアント側
			<ul>
				<li>
					エンドポイント(DNS)を利用したフェイルオーバー
					<ul>
						<li>クラスターエンドポイントはその時のマスターのIPアドレスを返すので、通常30秒以内で新しいマスターに接続できるようになるはずである</li>
						<li>クライアント側で再接続する仕組みは必要</li>
						<li>DNSの情報はいろいろなレイヤーでキャッシュされるので、キャッシュの保持期間など設定の変更が推奨されるとのこと</li>
					</ul>
				</li>
				<li>
					高速フェイルオーバー
					<ul>
						<li>INFORMATION_SCHEMA.REPLICA_HOST_STATUS や @@innodb_read_only を利用したフェイルオーバー。どのインスタンスがマスターなのかや接続しているインスタンスがマスターなのかレプリカなのかがわかる。ニアリアルタイムの情報とのこと</li>
						<li>mariadb connector/jを使用した検証では4秒以下でフェイルオーバーした</li>
						<li>クライアント側に専用の処理が必要。公式でお勧めしているのはmariadb connector/jのドライバー</li>
						<li>
							mariadb connector/j (JDBCドライバー)
							<ul>
								<li>マスターとレプリカの両方に同時に接続をはる。</li>
								<li>マスターには指定した接続数だけはられるが、レプリカが複数ある場合は、レプリカについては指定した接続数が案分されて接続されるようである</li>
								<li>通常はマスターへの接続が使用される。Connection の setReadOnly を使用してtrueを設定した場合のみ、レプリカの接続が使用される</li>
								<li>高速フェイルオーバーを使用したい場合は、JDBC接続文字列に aurora オプションとクラスターエンドポイントを指定する必要がある。そこからドライバーがクラスターの情報を取得するとのこと</li>
								<li>読み取りエンドポイントのみを使用する場合はJDBC接続文字列にはフェイルオーバーオプション無しで、読み取りエンドポイントを指定する形になる</li>
								<li>レプリカからレプリカ(またはマスター)への高速フェイルオーバーはサポートしていないようである(マスタのみ)。読み取りエンドポイントを利用する方法のみ（要調査）</li>
							</ul>
						</li>
						<li>
							ProxySQL
							<ul>
								<li>クライアント(アプリ)とDBの間にプロキシとして配置する形になる。最近AWSの紹介ブログがあり、推しているぽい。高機能とのこと</li>
								<li>無償、OSS、GPLライセンス</li>
								<li>要調査。これはこれで管理する必要があるレイヤーが増えるが・・・</li>
							</ul>
						</li>
					</ul>
				</li>
			</ul>
		</li>
	</ul>
<hr>
</div>
</div>
</body>
</html>